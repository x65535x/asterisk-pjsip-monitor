# Asterisk PJSIP Monitor

Веб-интерфейс для управления секциями конфигурации Asterisk PJSIP с **реальным мониторингом** статуса телефонов, звонков и логов.

## 🚀 Быстрое развертывание на сервере

- **⚡ Для боевого сервера:** [SERVER_QUICKSTART.md](SERVER_QUICKSTART.md)
- **📖 Подробная инструкция:** [PRODUCTION_DEPLOY.md](PRODUCTION_DEPLOY.md)
- **🔧 Скрипт развертывания:** [deploy.sh](deploy.sh)

## 🚀 Новые возможности мониторинга

- 📊 **Реальный мониторинг** статуса SIP-телефонов (Online/Offline)
- 📞 **Индикация активных звонков** с анимацией
- 📋 **Просмотр логов в реальном времени** для каждой секции
- 🔔 **WebSocket обновления** без перезагрузки страницы
- 📈 **AMI интеграция** для получения данных из Asterisk
- 🎯 **Фильтрация логов** по уровню и источнику

## Возможности

- 📋 Просмотр списка существующих секций с индикаторами статуса
- ➕ Создание новых секций с автогенерацией шаблонов
- ✏️ Редактирование секций с подсветкой синтаксиса (CodeMirror)
- 🔐 HTTP Basic аутентификация
- 🔄 Автоматическая перезагрузка Asterisk после изменений
- 📱 Современный отзывчивый веб-интерфейс
- 🟢 **Статус регистрации** SIP-телефонов в реальном времени
- 📞 **Мониторинг звонков** с индикацией активных вызовов
- 📋 **Логи в реальном времени** с фильтрацией и поиском

## Установка

1. Убедитесь, что у вас установлен Node.js (версия 14 или выше)
2. Клонируйте проект:
   ```bash
   git clone <репозиторий>
   cd asterisk-pjsip-monitor
   ```
3. Установите зависимости:
   ```bash
   npm install
   ```

## Настройка

### 1. Базовая настройка

1. Убедитесь, что файл `/etc/asterisk/pjsip.conf` существует и доступен для записи
2. Настройте sudo права для перезагрузки Asterisk:
   ```bash
   sudo visudo
   # Добавьте строку (замените your_user на имя пользователя):
   your_user ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload asterisk
   ```
3. Измените пароль в файле `app.js` (строка с `USERS`):
   ```javascript
   const USERS = { admin: 'your_new_password' };
   ```

### 2. Настройка мониторинга (AMI)

Для полноценного мониторинга настройте Asterisk Manager Interface:

1. Отредактируйте `/etc/asterisk/manager.conf`:
   ```ini
   [general]
   enabled = yes
   port = 5038
   bindaddr = 127.0.0.1

   [admin]
   secret = your_ami_password
   deny = 0.0.0.0/0.0.0.0
   permit = 127.0.0.1/255.255.255.255
   read = system,call,log,verbose,command,agent,user,config,dtmf,reporting,cdr,dialplan
   write = system,call,log,verbose,command,agent,user,config,dtmf,reporting,cdr,dialplan
   ```

2. Обновите настройки AMI в `app.js`:
   ```javascript
   const AMI_CONFIG = {
     port: 5038,
     host: 'localhost',
     username: 'admin',
     password: 'your_ami_password',
     events: 'on'
   };
   ```

3. Настройте логирование в `/etc/asterisk/logger.conf`:
   ```ini
   [logfiles]
   console => notice,warning,error
   messages => notice,warning,error
   full => notice,warning,error,debug,verbose
   ```

4. Перезапустите Asterisk:
   ```bash
   sudo systemctl restart asterisk
   ```

Подробная инструкция в файле `asterisk-ami-config.md`.

## Запуск

### Тестирование:
```bash
npm run test
```
*Запускает версию с симуляцией мониторинга для демонстрации*

### Режим разработки:
```bash
npm run dev
```

### Продакшн:
```bash
npm start
```

Приложение будет доступно по адресу: http://localhost:8080

## Использование

1. Откройте браузер и перейдите на http://localhost:8080
2. Введите логин: `admin` и пароль: `secret123` (или измененный вами)
3. На главной странице вы увидите секции с индикаторами статуса:
   - 🟢 **Зеленый** - телефон зарегистрирован и доступен
   - 🔴 **Красный** - телефон не зарегистрирован или недоступен
   - 🟡 **Желтый (мигающий)** - активный звонок
4. Нажмите **"📋 Logs"** для просмотра логов в реальном времени
5. Используйте **"🔄 Refresh"** для принудительного обновления статуса

### Мониторинг логов

- Кликните на **"📋 Logs"** напротив любой секции
- Логи отображаются в реальном времени
- Доступна фильтрация по:
  - Тексту сообщения
  - Уровню (ERROR, WARNING, NOTICE, DEBUG)
  - Источнику (PJSIP, res_pjsip, app_dial)
- Автопрокрутка и статистика

## Формат секций

Секции в файле pjsip.conf должны быть помечены специальными комментариями:

```ini
;--- section_name ---
[section-config]
type = endpoint
...
;/--- section_name ---
```

## Индикаторы статуса

| Индикатор | Описание |
|-----------|----------|
| 🟢 Online | SIP-телефон зарегистрирован и доступен |
| 🔴 Offline | SIP-телефон не зарегистрирован |
| ❓ Unknown | Статус неизвестен (нет данных от AMI) |
| 📞 X calls | Количество активных звонков |
| ⚡ Мигающая граница | Активный звонок в данный момент |

## Безопасность

- Приложение использует HTTP Basic аутентификацию
- Измените стандартный пароль перед использованием в продакшене
- Настройте AMI с безопасными паролями
- Убедитесь, что приложение запущено в безопасной сети
- Рекомендуется использовать HTTPS в продакшене

## Требования

- Node.js 14+
- Asterisk с PJSIP
- Доступ на запись к `/etc/asterisk/pjsip.conf`
- Права sudo для перезагрузки Asterisk
- **Для мониторинга**: настроенный AMI в Asterisk
- **Для логов**: доступ к файлам логов Asterisk

## Архитектура мониторинга

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   Browser   │◄──►│   Node.js    │◄──►│  Asterisk   │
│  (WebSocket)│    │ (Socket.IO)  │    │    (AMI)    │
└─────────────┘    └──────────────┘    └─────────────┘
                          │
                          ▼
                   ┌──────────────┐
                   │  Log Files   │
                   │  Monitoring  │
                   └──────────────┘
```

## Лицензия

MIT 